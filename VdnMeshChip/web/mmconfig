#!/bin/bash

<<Interface_Modes

 Interface: wlan1 = AP for all modes.

 Parameters: type, Callsign, NodeId, AdminPassword, NodeCH, Eth0Mode, RouterName, WifiSSID, WifiPassword, Eth0Use, apSSID, apPASS, apCH

Interface_Modes

#PS4='$LINENO: '
#set -x

checkInterfaces()
{
if [ -d "/sys/class/net/eth0" ]; then 
  echo "TRUE" 
else
  echo "FALSE"
fi
}

connectWifi()
{
# Connect to Wifi
sudo nmcli dev disconnect wlan0 2>&1
sudo nmcli device wifi connect $wifiSSID password $wifiPASS ifname wlan0 2>&1
}

createAP()
{
# Build /etc/hostapd.conf file
newfile="/etc/hostapd.conf"
echo "interface=wlan1" > $newfile
echo "driver=nl80211" >> $newfile
echo "ssid=$apSSID" >> $newfile
echo "channel=$apCH" >> $newfile
echo "auth_algs=3" >> $newfile
echo "max_num_sta=10" >> $newfile
echo "wpa=2" >> $newfile
echo "wpa_passphrase=$apPASS" >> $newfile
echo "wpa_pairwise=TKIP CCMP" >> $newfile
echo "rsn_pairwise=CCMP" >> $newfile
echo "ctrl_interface=/var/run/hostapd" >> $newfile

# Restart Services
[ -f "/var/run/hostapd/wlan1" ] && rm -r "/var/run/hostapd/wlan1"
sudo /usr/sbin/update-rc.d hostapd disable
sudo /bin/systemctl daemon-reload
sudo /bin/systemctl enable hostapd-systemd
sudo /bin/systemctl restart hostapd-systemd
}

createADHOC()
{
# Lets Calculate the IP Address via Mac Address
macID=`ifconfig wlan0 | grep HWaddr | awk '{ print $5}'`
oct1="0x0a"
oct2="0x${macID:9:2}"
oct3="0x${macID:12:2}"
oct4="0x${macID:15:2}"
nodeIP=`printf "%d.%d.%d.%d\n" $oct1 $oct2 $oct3 $oct4`

echo "auto wlan0" >> /etc/network/interfaces
echo "iface wlan0 inet static" >> /etc/network/interfaces
echo "address $nodeIP" >> /etc/network/interfaces
echo "netmask 255.0.0.0" >> /etc/network/interfaces
echo "wireless-channel $nodeCH" >> /etc/network/interfaces
echo "wireless-essid $nodeID" >> /etc/network/interfaces
echo "wireless-mode ad-hoc" >> /etc/network/interfaces  
}

# Start of Script
clear
if [[ $# -eq 0 ]]; then checkInterfaces; exit 0; fi

nodeType=$1

# Get all Parameter Values
  callsign=$2
  nodeID=$3
  adminPASS=$4
  nodeCH=$5
  nodeEthMode=$6
  shift; shift; shift; shift; shift; shift;
  routerName=$1
  wifiSSID=$2
  wifiPASS=$3
  routeEthMode=$4
  apSSID=$5
  apPASS=$6
  apCH=$7

# Router Mode
if [[ $nodeType == "microrouter" ]]; then  

  echo "Router [$routerName]"
  echo "Wifi [$wifiSSID]"
  echo "WifiPassword [$wifiPASS]"
  echo "Eth Mode [$routeEthMode]"
  echo "AP [$apSSID]"
  echo "AP-Pass [$apPASS]"
  echo "AP-CH [$apCH]"
  echo

wlanIP=`ifconfig wlan1 | grep "inet addr" | cut -d ':' -f 2 | cut -d ' ' -f 1`
echo -e "127.0.0.1\tlocalhost" > /etc/hosts
echo -e "$wlanIP\t$routerName" >> /etc/hosts
echo "::1       localhost ip6-localhost ip6-loopback" >> /etc/hosts
echo "ff02::1   ip6-allnodes" >> /etc/hosts
echo "ff02::2   ip6-allrouters" >> /etc/hosts

echo $routerName > /etc/hostname
/etc/init.d/dnsmasq restart
connectWifi
createAP

fi

# Mesh Mode
if [[ $nodeType == "micromesh" ]]; then 

  echo "Callsign [$callsign]"
  echo "NodeID [$nodeID]"
  echo "Admin Password [$adminPASS]"
  echo "Node Channel [$nodeCH]"
  echo "Node Ethernet Mode [$nodeEthMode]"
  echo
  echo "Router [$routerName]"
  echo "Wifi [$wifiSSID]"
  echo "WifiPassword [$wifiPASS]"
  echo "Eth Mode [$routeEthMode]"
  echo "AP [$apSSID]"
  echo "AP-Pass [$apPASS]"
  echo "AP-CH [$apCH]"
  echo

createADHOC

if [ -L /etc/resolv.conf ]; then
    rm -f /etc/resolv.conf
    touch /etc/resolv.conf
fi

sudo bash -c "echo 'nameserver 8.8.8.8' > /etc/resolv.conf"


fi
