#!/bin/bash

<<Interface_Modes

 Interface: wlan1 = AP for all modes.

 Parameters: type, Callsign, NodeId, AdminPassword, NodeCH, Eth0Mode, RouterName, WifiSSID, WifiPassword, Eth0Use, apSSID, apPASS, apCH, nodeSSID

Interface_Modes

#---[ GLOBAL VARIABLES ]--------------------------------------------------------------

defaultWLAN=wlan1
defaultLAN=eth0

#---[ FUNCTIONS ]---------------------------------------------------------------------

createADHOC() {
    
    sudo iwconfig $defaultWLAN mode ad-hoc
    sudo iwconfig $defaultWLAN channel $nodeCH
    sudo iwconfig $defaultWLAN essid $nodeSSID
    sudo iwconfig $defaultWLAN key off
    sudo ifconfig $defaultWLAN up
    getIP $defaultWLAN
    
    # add to /etc/network/interfaces
    sudo echo "" > /etc/network/interfaces
    sudo echo "# Created by VDN Scripts... Do not edit directly, changes will be lost !" >> /etc/network/interfaces
    sudo echo -e "\nauto lo" >> /etc/network/interfaces
    sudo echo -e "iface lo inet loopback\n" >> /etc/network/interfaces
    
    sudo echo -e "\nauto $defaultWLAN" >> /etc/network/interfaces
    sudo echo -e "iface $defaultWLAN inet static " >> /etc/network/interfaces
    sudo echo -e "\taddress $nodeIP" >> /etc/network/interfaces
    sudo echo -e "\tnetmask 255.0.0.0 " >> /etc/network/interfaces
    sudo echo -e "\twireless-channel $nodeCH " >> /etc/network/interfaces
    sudo echo -e "\twireless-essid $nodeSSID" >> /etc/network/interfaces
    sudo echo -e "\twireless-mode ad-hoc\n" >> /etc/network/interfaces
}


createAP() {
    
    # Configure the WiFi access point on wlan1
    sudo echo "interface=$defaultWLAN" > /etc/hostapd.conf
    sudo echo "driver=nl80211" >> /etc/hostapd.conf
    sudo echo "ssid=$apSSID" >> /etc/hostapd.conf
    sudo echo "channel=$apCH" >> /etc/hostapd.conf
    sudo echo "auth_algs=3" >> /etc/hostapd.conf
    sudo echo "max_num_sta=10" >> /etc/hostapd.conf
    sudo echo "wpa=2" >> /etc/hostapd.conf
    sudo echo "wpa_passphrase=$apPASS" >> /etc/hostapd.conf
    sudo echo "wpa_pairwise=TKIP CCMP" >> /etc/hostapd.conf
    sudo echo "rsn_pairwise=CCMP" >> /etc/hostapd.conf
    sudo echo "ctrl_interface=/var/run/hostapd" >> /etc/hostapd.conf
    
    sudo echo -e "$apSSID" > /var/www/flags/.apSSID
    sudo echo -e "$apPASS" > /var/www/flags/.apPASS
    sudo echo -e "$apCH" > /var/www/flags/.apChannel
    
    
    # Add call to vdn-router
    if [ ! -f "/var/www/flags/.microrouter" ]; then
        sudo echo "" >> /usr/sbin/vdn-router
        sudo echo "# Start the Access Point" >> /usr/sbin/vdn-router
        sudo echo "/usr/sbin/hostapd /etc/hostapd.conf" >> /usr/sbin/vdn-router
    fi
    
    # Remove Mesh-Node config files.
    sudo rm /etc/dnsmasq.d/mesh-node.conf
    
    # Restart Services
    sudo /usr/sbin/update-rc.d hostapd disable
    sudo /bin/systemctl daemon-reload
    sudo /bin/systemctl enable hostapd-systemd
    sudo /bin/systemctl start hostapd-systemd
    sudo /bin/systemctl status hostapd-systemd
}


createDHCP() {
    
    interfaceDHCP=$1        # Interface serving the DHCP
    interfaceGateway=$2     # Interface providing IP and DNS Forwarding
    nodeIP="127.20.0.1"
    # Set up a static IP for the AP(accesspoint)
    echo "adding $interfaceDHCP to /etc/network/interfaces"
    
    ifconfig $interfaceDHCP $nodeIP
    sudo echo "" > /etc/network/interfaces
    sudo echo "# Created by VDN Scripts... Do not edit directly, changes will be lost !" >> /etc/network/interfaces
    sudo echo "# automatically re-created during install & updates" >> /etc/network/interfaces
    sudo echo "auto lo" >> /etc/network/interfaces
    sudo echo -e "iface lo inet loopback\n" >> /etc/network/interfaces
    sudo echo "auto $interfaceDHCP" >> /etc/network/interfaces
    sudo echo "iface $interfaceDHCP inet static" >> /etc/network/interfaces
    sudo echo "    address 172.20.0.1" >> /etc/network/interfaces
    sudo echo "    netmask 255.255.255.0" >> /etc/network/interfaces
    
    # Restart the hosting interface:
    echo "spinning down $interfaceDHCP"
    sudo ifdown $interfaceDHCP
    echo "spinning up $interfaceDHCP"
    sudo ifup $interfaceDHCP
    
    # Create Dnsmasq & Restart the DHCP server
    echo "Writing to /etc/dnsmasq.d/access-point.conf"
    sudo rm -r /etc/dnsmasq.d/*.conf
    sudo echo "" > /etc/dnsmasq.d/access-point.conf
    sudo echo "# Created by VDN Scripts... Do not edit directly, changes will be lost !" >> /etc/dnsmasq.d/access-point.conf
    sudo echo -e "\ninterface=$interfaceDHCP" >> /etc/dnsmasq.d/access-point.conf
    sudo echo -e "\nexcept-interface=$interfaceGateway" >> /etc/dnsmasq.d/access-point.conf
    sudo echo -e "\ndhcp-range=172.20.0.100,172.20.0.250,1h" >> /etc/dnsmasq.d/access-point.conf
    
    echo "restarting dnsmasq"
    sudo /etc/init.d/dnsmasq restart
}


createHosts()
{
    
    # Update host file and hostname
    sudo echo "Updating hosts file with hostname:$newHostName"
    sudo echo "#Created by VDN Scripts. Do not edit !!!" > /etc/hosts
    sudo echo "127.0.0.1 localhost" >> /etc/hosts
    sudo echo "$nodeIP $newHostName" >> /etc/hosts
    sudo echo "::1 localhost ip6-localhost ip6-loopback" >> /etc/hosts
    sudo echo "ff02::1 ip6-allnodes" >> /etc/hosts
    sudo echo "ff02::2 ip6-allrouters" >> /etc/hosts
}


getIP() {
    
    
    #Create IP Address for IFACE based on MAC Address
    echo -e "\nCalculating the IP Address for Interface:$1"
    MACID=`cat /sys/class/net/$1/address`
    MAC4=`echo $MACID | cut -d : -f 4 `
    MAC5=`echo $MACID | cut -d : -f 5 `
    MAC6=`echo $MACID | cut -d : -f 6 `
    ip1=10
    ip2=`printf %d 0x$MAC4 `
    ip3=`printf %d 0x$MAC5 `
    ip4=`printf %d 0x$MAC6 `
    [ $1 == "eth0" ] && lanIP=$ip1.$ip3.$ip4."1"    && ifconfig $1 $lanIP && dhcpStart=$ip1.$ip3.$ip4 && echo -e "lanIP=$lanIP\n"
    [ $1 == $defaultWLAN ] && nodeIP=$ip1.$ip2.$ip3.$ip4 && ifconfig $1 $nodeIP && echo -e "nodeIP=$nodeIP\n"
}


createOLSR() {
    
    # Create the OLSRD Config File
    sudo cp /etc/default/olsrd.conf.vdn /etc/olsrd/olsrd.conf
    sudo sed -i.bak "s/.*MainIp.*/MainIp $nodeIP/" /etc/olsrd/olsrd.conf
    sudo sed -i.bak "s/.*Interface.*/Interface \"$defaultWLAN\"/" /etc/olsrd/olsrd.conf
    sudo sed -i.bak "s/.*PlParam \"name\".*/    PlParam \"name\" \"$nodeID\"/" /etc/olsrd/olsrd.conf
    #sudo sed -i.bak "s/.*#   0.0.0.0      0.0.0.0.*/$INET_ADDRESS  255.255.255.255/" /etc/olsrd/olsrd.conf
    
    # Packet masquerading - /etc/rc.local
    sudo sed -i.bak "s/.*to-source.*/iptables -t nat -A POSTROUTING -o $defaultWLAN -j SNAT --to-source $nodeIP/" /etc/rc.local
    sudo sed -i.bak "s/wlan./$defaultWLAN/g" /etc/rc.local
    
    # Update resolv.conf file
    sudo echo "# Generated by VDN Scripts" > /etc/resolv.conf
    sudo echo "127.0.0.1" >> /etc/resolv.conf
    sudo echo "8.8.8.8" >> /etc/resolv.conf
}


createRouter() {
    routerSource=$1
    routerDestination=$2
    sudo echo "#!/bin/bash" > /usr/sbin/vdn-router
    sudo echo "" >> /usr/sbin/vdn-router
    sudo echo "# Make sure interface $routerSource is up" >> /usr/sbin/vdn-router
    sudo echo "ifdown $routerSoure" >> /usr/sbin/vdn-router
    sudo echo "ifup $routerSource" >> /usr/sbin/vdn-router
    sudo echo "" >> /usr/sbin/vdn-router
    sudo echo "# Enable DNS forwarding" >> /usr/sbin/vdn-router
    sudo echo "sysctl -w net.ipv4.ip_forward=1" >> /usr/sbin/vdn-router
    sudo echo "" >> /usr/sbin/vdn-router
    sudo echo "# Enable NAT" >> /usr/sbin/vdn-router
    sudo echo "iptables -t nat -A POSTROUTING -o $routerDestination -j MASQUERADE" >> /usr/sbin/vdn-router
}


connectWifi() {
    # Connect to Wifi
    echo "disconnecting any existing connections on $defaultWLAN"
    sudo nmcli dev disconnect $defaultWLAN 2>&1
    echo "connecting to WiFi ($wifiSSID) on $defaultWLAN"
    sudo nmcli device wifi connect $wifiSSID password $wifiPASS ifname $defaultWLAN 2>&1
    echo -e "$wifiSSID" > /var/www/flags/.wifiSSID
    echo -e "$wifiPASS" > /var/www/flags/.wifiPASS
}


setupMeshEthernet() {
    meshEthernetMode=$1        # Ethernet Mode
    
    [ -f "/var/www/flags/.lan" ] && rm /var/www/flags/.lan
    [ -f "/var/www/flags/.wan" ] && rm /var/www/flags/.wan
    
    getIP $defaultLAN
    getIP $defaultWLAN
    nodeID=$(hostname)
    
    # LAN Mode...
    if [[ $meshEthernetMode == "LAN" ]]; then
        sudo touch /var/www/flags/.lan
        echo "SETUP MeshAccessPoint on $defaultWLAN with IP Forwarding to $defaultLAN"
        #       getIP $defaultWLAN
        sudo echo -e "\nauto $defaultLAN" >> /etc/network/interfaces
        sudo echo -e "iface $defaultLAN inet static" >> /etc/network/interfaces
        sudo echo -e "\taddress $lanIP" >> /etc/network/interfaces
        sudo echo -e "\tnetmask 255.255.255.0\n" >> /etc/network/interfaces
        # update dnsmasq
        sudo cp /etc/default/dnsmasq.vdn /etc/default/dnsmasq
        sudo cp /etc/default/mesh-node.vdn /etc/dnsmasq.d/mesh-node.conf
        sudo sed -i.bak "s/.*#interface=$defaultLAN.*/interface=$defaultLAN/" /etc/dnsmasq.d/mesh-node.conf
        sudo sed -i.bak "s/.*dhcp-range=.*/dhcp-range=$dhcpStart.100,$dhcpStart.105,255.255.255.0,1H/" /etc/dnsmasq.d/mesh-node.conf
        sudo sed -i.bak "s|#address=/localnode.*|address=/localnode/$nodeIP|" /etc/dnsmasq.d/mesh-node.conf
        sudo sed -i.bak "s|.*address=/node-id.*|address=/$nodeID/$nodeIP|" /etc/dnsmasq.d/mesh-node.conf
        
        sudo /etc/init.d/networking restart
    fi
    
    
    if [[ $meshEthernetMode == "WAN" ]]; then
        sudo touch /var/www/flags/.wan
        echo "Setting up DHCP and IP Forwarding to $defaultLAN"
        #       getIP $defaultWLAN
        sudo echo -e "\nauto $defaultLAN" >> /etc/network/interfaces
        sudo echo -e "iface $defaultLAN inet dhcp" >> /etc/network/interfaces
        sudo /etc/init.d/networking restart
        # update dnsmasq
        sudo cp /etc/default/dnsmasq.vdn /etc/default/dnsmasq
        sudo cp /etc/default/mesh-node.vdn /etc/dnsmasq.d/mesh-node.conf
        sudo sed -i.bak "s/.*interface=$defaultLAN.*/#interface=$defaultLAN/" /etc/dnsmasq.d/mesh-node.conf
        sudo sed -i.bak "s/.*dhcp-range=.*/#dhcp-range=$dhcpStart.100,$dhcpStart.105,255.255.255.0,1H/" /etc/dnsmasq.d/mesh-node.conf
        sudo sed -i.bak "s|.*address=/localnode.*|#address=/localnode/$nodeIP|" /etc/dnsmasq.d/mesh-node.conf
        sudo sed -i.bak "s|.*address=/node-id.*|#address=/$nodeID/$nodeIP|" /etc/dnsmasq.d/mesh-node.conf
    fi
}

setupRouterEthernet() {
    if [[ $# -lt 1 ]]; then
        echo "mmconfig::setupRouterEthernet() No arguments provided"
        exit 1
    fi
    
    defaultWLAN=wlan0
    
    # --- Setting variables from function call ---
    routerEthMode=$1    # Ethernet Mode (ETH, WLAN)
    case $routerEthMode in
        
        ETH )
            # Setup eth connection as the gateway
            shift;
            if [[ $# -lt 4 ]]; then
                echo "mmconfig::setupRouterEthernet() ETH mode requires more arguments"
                exit 1
            fi
            routerName=$1
            apSSID=$2
            apPASS=$3
            apCH=$4
            
            newHostName=$routerName
            nodeIP="127.20.0.1"
            createHosts
            sudo echo $newHostName > /etc/hostname
            sudo hostname $newHostName
            /etc/rc.local
            echo -e " [updated node name to $newHostName] "
            
            echo "Router [$routerName]"
            echo "Eth Mode [$routerEthMode]"
            echo "AP [$apSSID]"
            echo "AP-Pass [$apPASS]"
            echo "AP-CH [$apCH]"
            echo ""
            
            # Remove existing Flags
            [ -f "/var/www/flags/.wlan" ] && rm /var/www/flags/.wlan
            
            sudo touch /var/www/flags/.eth
            echo "SETUP AccessPoint on $defaultWLAN with IP Forwarding to $defaultLAN"
            createDHCP $defaultWLAN $defaultLAN
            createRouter $defaultWLAN $defaultLAN
            createAP
        ;;
        
        WLAN )
            # Setup wlan connection as the gateway
            shift;
            if [[ $# -lt 3 ]]; then
                echo "mmconfig::setupRouterEthernet() WLAN mode requires more arguments"
                exit 1
            fi
            routerName=$1
            wifiSSID=$2
            wifiPASS=$3
            
            newHostName=$routerName
            nodeIP="127.20.0.1"
            createHosts
            sudo echo $newHostName > /etc/hostname
            sudo hostname $newHostName
            /etc/rc.local
            echo -e " [updated node name to $newHostName] "
            
            echo "Router [$routerName]"
            echo "Wifi [$wifiSSID]"
            echo "WifiPassword [$wifiPASS]"
            echo "Eth Mode [$routerEthMode]"
            echo ""
            
            # Remove existing Flags
            [ -f "/var/www/flags/.eth" ] && rm /var/www/flags/.eth
            
            sudo touch /var/www/flags/.wlan
            defaultWLAN=wlan0
            echo "Setting up DHCP and IP Forwarding to $defaultLAN"
            createDHCP $defaultLAN $defaultWLAN
            createRouter $defaultLAN $defaultWLAN
            echo "CONNECT to WiFi Hotspot using $defaultWLAN"
            connectWifi
            
            # Start Service
            sudo /bin/systemctl daemon-reload
            sudo /bin/systemctl enable router-systemd
            sudo /bin/systemctl start router-systemd
            sudo /bin/systemctl status router-systemd
        ;;
        
        * )
            echo "mmconfig::setupRouterEthernet() Supported modes are ETH or WLAN"
            exit 1
        ;;
    esac
    
    # Set installation type flag for status page.
    sudo touch /var/www/flags/.microrouter
}

#---[ MAIN ]----------------------------------------------------------------------------------

clear

if [[ $# -lt 1 ]]; then echo "invalid or no parameters used !"; exit 1; fi

request=$1

if [[ $request == "check" ]]; then
    if [[ $2 == "installed" ]]; then [ -e "/var/www/html/.installed" ] && echo "TRUE" || echo "FALSE"; fi
    if [[ $2 == "ethernet" ]]; then [ -d "/sys/class/net/eth0" ] && echo "TRUE" || echo "FALSE"; fi
    exit 0
fi

if [[ $request == "update" ]]; then
    shift
    while [ $# -gt 0 ]
    do
        [ -f /var/www/flags/.microrouter ] && defaultWLAN=wlan0
        [ -f /var/www/flags/.micromesh ] && defaultWLAN=wlan1
        
        case "$1" in
            
            adminPASS )
                #Change admin password
                echo $2 > /var/www/flags/.admin
                echo -e " [updated admin password] "
                shift; shift;
            ;;
            
            apChannel )
                #update channel
                sudo sed -i.bak "s/.*channel=.*/channel=$2/" /etc/hostapd.conf
                shift; shift;
                # Update any required services.
                sudo systemctl restart hostapd-systemd
            ;;
            
            apName )
                #Change Router Name
                echo $2 > /etc/hostname
                sudo sed -i.bak "s/.*127.0.0.1 localhost.*/127.0.0.1 localhost $2/" /etc/hosts
                shift; shift;
                # Update any required services.
                systemctl restart hostapd-systemd
            ;;
            
            apPASS )
                #Change access point password
                sudo sed -i.bak "s/.*wpa_passphrase=.*/wpa_passphrase=$2/" /etc/hostapd.conf
                shift; shift;
                # Update any required services.
                sudo systemctl restart hostapd-systemd
                
            ;;
            
            apSSID )
                #update ssid
                sudo sed -i.bak "s/.*ssid=.*/ssid=$2/" /etc/hostapd.conf
                shift; shift;
                # Update any required services.
                sudo systemctl restart hostapd-systemd
            ;;
            
            callsign )
                echo -e $2 > /var/www/flags/.callsign
                echo -e " [updated callsign to $2] "
                shift; shift;
            ;;
            
            meshSSID )
                #update ssid
                sudo sed -i.bak "s/.*wireless-essid.*/\twireless-essid $2/" /etc/network/interfaces
                sudo ifconfig $defaultWLAN down
                sudo ifconfig $defaultWLAN up
                echo -e " [updated node to SSID $2] "
                shift; shift;
                sudo /etc/init.d/networking restart;cat /etc/network/interfaces
            ;;
            
            meshChannel )
                #update channel
                sudo sed -i.bak "s/.*wireless-channel.*/\twireless-channel $2/" /etc/network/interfaces
                sudo ifconfig $defaultWLAN down
                sudo ifconfig $defaultWLAN up
                echo -e " [updated node to channel $2] "
                shift; shift;
                sudo /etc/init.d/networking restart
            ;;
            
            meshName )
                #Change mesh node Name
                newHostName=$2
                getIP $defaultWLAN
                createHosts
                sudo echo $2 > /etc/hostname
                sudo hostname $2
                sudo sed -i.bak "s/.*PlParam \"name\".*/    PlParam \"name\" \"$2\"/" /etc/olsrd/olsrd.conf
                /etc/rc.local
                echo -e " [updated node name to $2] "
                shift; shift;
            ;;
            
            meshEthernetType )
                setupMeshEthernet $2
                echo -e " [updated node to use ethernet as $2] "
                shift; shift;
            ;;
            
            routerEthernetType )
                setupRouterEthernet $2 $3 $4 $5 $6
                echo -e " [updated node to use $2 as the gateway interface] "
                exit 0
            ;;
        esac
    done
    
    exit 0
fi

# Remove existing Flags
[ -f "/var/www/flags/.installed" ] && rm /var/www/flags/.installed
[ -f "/var/www/flags/.micromesh" ] && rm /var/www/flags/.micromesh
[ -f "/var/www/flags/.microrouter" ] && rm /var/www/flags/.microrouter
[ -f "/var/www/flags/.admin" ] && rm /var/www/flags/.admin
[ -f "/var/www/flags/.lan" ] && rm /var/www/flags/.lan
[ -f "/var/www/flags/.wan" ] && rm /var/www/flags/.wan
[ -f "/var/www/flags/.eth" ] && rm /var/www/flags/.eth
[ -f "/var/www/flags/.wlan" ] && rm /var/www/flags/.wlan

# Get all Parameter Values
callsign=$2
nodeID=$3
adminPASS=$4
nodeCH=$5
meshEthMode=$6
shift; shift; shift; shift; shift; shift;
routerName=$1
wifiSSID=$2
wifiPASS=$3
routerEthMode=$4
apSSID=$5
apPASS=$6
apCH=$7
nodeSSID=$8

# Record password...
sudo echo -e $adminPASS > /var/www/flags/.admin


# Router Mode
if [[ $request == "microrouter" ]]; then
    #  [[ $routerEthMode == "ETH" ]] && setupRouterEthernet $routerEthMode $routerName $apSSID $apPASS $apCH
    #  [[ $routerEthMode == "WLAN" ]] && setupRouterEthernet $routerEthMode $routerName $wifiSSID $wifiPASS
    
    if [[ $routerEthMode == "ETH" ]]; then
        setupRouterEthernet $routerEthMode $routerName $apSSID $apPASS $apCH
    fi
    
    if [[ $routerEthMode == "WLAN" ]]; then
        setupRouterEthernet $routerEthMode $routerName $wifiSSID $wifiPASS
    fi
fi

# Mesh Mode
if [[ $request == "micromesh" ]]; then
    
    defaultWLAN=wlan1
    
    newHostName=$nodeID
    echo "Callsign [$callsign]"
    echo "NodeID [$nodeID]"
    echo "Admin Password [$adminPASS]"
    echo "Node Channel [$nodeCH]"
    echo "Node Ethernet Mode [$meshEthMode]"
    echo "Node SSID [$nodeSSID]"
    echo ""
    
    sudo echo -e $callsign > /var/www/flags/.callsign
    
    createADHOC
    createOLSR
    setupMeshEthernet $meshEthMode
    
    
    # Remove Access-Point config files.
    [ -f "/etc/dnsmasq/d/access_point.conf" ] && rm /etc/dnsmasq.d/access_point.conf
    
    # Start Services
    echo "restarting dnsmasq"
    sudo systemctl daemon-reload
    sudo /etc/init.d/dnsmasq restart
    sudo /etc/rc.local
    
    # Set installation type flag for status page.
    sudo touch /var/www/flags/.micromesh
fi

# FINISHED SETUP
echo "setting installed flag"
sudo touch /var/www/flags/.installed

# Set Timezone to EST
echo "setting timezone"
sudo timedatectl set-timezone EST

# Change Hostname, no longer chip
echo "running createHosts()"
createHosts

echo "setting hostname to $newHostName"
echo $newHostName > /etc/hostname